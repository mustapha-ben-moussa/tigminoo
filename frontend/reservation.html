<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>R√©server un logement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="index.html">Tigminoo</a>
    <div class="navbar-nav">
      <a class="nav-link" href="index.html">Accueil</a>
      <a class="nav-link" href="logements.html">Logements</a>
      <a class="nav-link" href="profil.html">Profil</a>
    </div>
  </div>
</nav>

<div class="container py-5">
  <h2>R√©server ce logement</h2>

  <div class="card mb-4">
    <div class="card-body">
      <h5 id="logementTitre">Chargement...</h5>
      <p id="logementInfo"></p>
    </div>
  </div>

  <form id="reservationForm">
    <div class="mb-3">
      <label for="date_debut" class="form-label">Date de d√©but</label>
      <input type="date" id="date_debut" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="date_fin" class="form-label">Date de fin</label>
      <input type="date" id="date_fin" class="form-control" required>
    </div>

    <div id="disponibilite" class="alert" style="display: none;"></div>

    <button type="submit" class="btn btn-success">R√©server</button>
    <a href="logements.html" class="btn btn-secondary">Retour</a>
  </form>

  <div id="msg" class="mt-3"></div>
</div>

<script src="auth.js"></script>
<script>
/* üîê V√©rifier client connect√© */
if (!checkUserType('client')) {
  // Redirection g√©r√©e par checkUserType
}

/* üîé R√©cup√©rer l'id logement depuis l'URL */
const params = new URLSearchParams(window.location.search);
const id_logement = params.get("id");

if (!id_logement) {
  alert("Logement introuvable");
  window.location.href = "logements.html";
}

let reservations = [];

/* ================= CHARGER INFOS LOGEMENT ================= */
fetch(`http://localhost:3000/logements/${id_logement}`)
  .then(res => res.json())
  .then(logement => {
    document.getElementById("logementTitre").innerText = logement.titre;
    document.getElementById("logementInfo").innerText = 
      `${logement.ville} - ${logement.prix_par_nuit}DH / nuit`;
  })
  .catch(err => {
    console.error(err);
    alert("Erreur de chargement");
  });

/* ================= CHARGER DATES R√âSERV√âES ================= */
fetch(`http://localhost:3000/reservations/logement/${id_logement}`)
  .then(res => res.json())
  .then(data => {
    reservations = data;
  })
  .catch(err => {
    console.error(err);
  });

/* ================= V√âRIFIER DISPONIBILIT√â ================= */
function isBlocked(date) {
  return reservations.some(r => {
    const d = new Date(date);
    const debut = new Date(r.date_debut);
    const fin = new Date(r.date_fin);
    return d >= debut && d <= fin;
  });
}

function isRangeBlocked(dateDebut, dateFin) {
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  
  return reservations.some(r => {
    const rDebut = new Date(r.date_debut);
    const rFin = new Date(r.date_fin);
    
    return (debut <= rFin && fin >= rDebut);
  });
}

// D√©finir date minimum √† aujourd'hui
const today = new Date().toISOString().split('T')[0];
document.getElementById("date_debut").min = today;
document.getElementById("date_fin").min = today;

document.getElementById("date_debut").addEventListener("change", e => {
  const disponibiliteDiv = document.getElementById("disponibilite");
  document.getElementById("date_fin").min = e.target.value;
  
  if (isBlocked(e.target.value)) {
    disponibiliteDiv.className = "alert alert-danger";
    disponibiliteDiv.innerText = "Date de d√©but d√©j√† r√©serv√©e ‚ùå";
    disponibiliteDiv.style.display = "block";
    e.target.value = "";
  } else {
    disponibiliteDiv.className = "alert alert-success";
    disponibiliteDiv.innerText = "Date disponible ‚úÖ";
    disponibiliteDiv.style.display = "block";
  }
});

document.getElementById("date_fin").addEventListener("change", e => {
  const disponibiliteDiv = document.getElementById("disponibilite");
  const dateDebut = document.getElementById("date_debut").value;
  
  if (isBlocked(e.target.value)) {
    disponibiliteDiv.className = "alert alert-danger";
    disponibiliteDiv.innerText = "Date de fin d√©j√† r√©serv√©e ‚ùå";
    disponibiliteDiv.style.display = "block";
    e.target.value = "";
  } else if (dateDebut && isRangeBlocked(dateDebut, e.target.value)) {
    disponibiliteDiv.className = "alert alert-danger";
    disponibiliteDiv.innerText = "Cette p√©riode chevauche une r√©servation existante ‚ùå";
    disponibiliteDiv.style.display = "block";
    e.target.value = "";
  } else {
    disponibiliteDiv.className = "alert alert-success";
    disponibiliteDiv.innerText = "P√©riode disponible ‚úÖ";
    disponibiliteDiv.style.display = "block";
  }
});

/* üìå R√©server */
document.getElementById("reservationForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const msgDiv = document.getElementById("msg");
  const dateDebut = document.getElementById("date_debut").value;
  const dateFin = document.getElementById("date_fin").value;

  if (!dateDebut || !dateFin) {
    msgDiv.innerHTML = '<div class="alert alert-warning">Veuillez remplir toutes les dates</div>';
    return;
  }

  if (new Date(dateDebut) >= new Date(dateFin)) {
    msgDiv.innerHTML = '<div class="alert alert-warning">La date de fin doit √™tre apr√®s la date de d√©but</div>';
    return;
  }

  try {
    msgDiv.innerHTML = '<div class="alert alert-info">Cr√©ation de la r√©servation...</div>';

    const response = await authenticatedFetch("http://localhost:3000/reservations", {
      method: "POST",
      body: JSON.stringify({
        date_debut: dateDebut,
        date_fin: dateFin,
        id_logement: id_logement
      })
    });

    const data = await response.json();

    if (response.ok) {
      msgDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
      
      setTimeout(() => {
        window.location.href = "profil.html";
      }, 2000);
    } else {
      msgDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
    }
  } catch (err) {
    console.error(err);
    msgDiv.innerHTML = '<div class="alert alert-danger">Erreur lors de la r√©servation</div>';
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>