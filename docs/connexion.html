<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tigminoo - Connexion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<div class="container py-5">
  <h1 class="text-center mb-4">Connexion & Inscription</h1>

  <div class="row">

    <!-- CONNEXION -->
    <div class="col-md-6">
      <h3>Connexion</h3>

      <form id="loginForm">
        <select id="typeLogin" class="form-select mb-3" required>
          <option value="">Vous êtes ?</option>
          <option value="client">client</option>
          <option value="hote">hôte</option>
        </select>

        <input id="email" type="email" class="form-control mb-3" placeholder="Email" required>
        <input id="password" type="password" class="form-control mb-3" placeholder="Mot de passe" required>

        <button type="submit" class="btn btn-primary w-100">
          Se connecter
        </button>
      </form>

      <div id="loginMessage" class="mt-3"></div>
    </div>

    <!-- INSCRIPTION -->
    <div class="col-md-6">
      <h3>Inscription</h3>

      <form id="registerForm">
        <select id="typeInscription" class="form-select mb-3" required>
          <option value="">Vous êtes ?</option>
          <option value="client">Client</option>
          <option value="hote">Hôte</option>
        </select>

        <input id="nom" class="form-control mb-3" placeholder="Nom" required>
        <input id="prenom" class="form-control mb-3" placeholder="Prénom" required>
        <input id="emailInscr" type="email" class="form-control mb-3" placeholder="Email" required>
        <input id="telephone" class="form-control mb-3" placeholder="Téléphone" required>
        <input id="passwordInscr" type="password" class="form-control mb-3" placeholder="Mot de passe (min 6 caractères)" required minlength="6">

        <button type="submit" class="btn btn-success w-100">
          S'inscrire
        </button>
      </form>

      <div id="registerMessage" class="mt-3"></div>
    </div>

  </div>
</div>

<script src="auth.js"></script>
<script>
// Vérifier si déjà connecté
if (isAuthenticated()) {
  window.location.href = "profil.html";
}

/* ================= CONNEXION ================= */
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const type = document.getElementById("typeLogin").value;
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const messageDiv = document.getElementById("loginMessage");

  if (!type) {
    messageDiv.innerHTML = '<div class="alert alert-warning">Choisissez Client ou Hôte</div>';
    return;
  }

  try {
    messageDiv.innerHTML = '<div class="alert alert-info">Connexion en cours...</div>';

    const response = await fetch("http://localhost:3000/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password, type })
    });

    const data = await response.json();

    if (response.ok) {
      // Stocker le token et les infos utilisateur
      setToken(data.token);
      setUser(data.user);

      messageDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
      
      setTimeout(() => {
        window.location.href = "profil.html";
      }, 1000);
    } else {
      messageDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
    }
  } catch (err) {
    console.error(err);
    messageDiv.innerHTML = '<div class="alert alert-danger">Erreur de connexion au serveur</div>';
  }
});

/* ================= INSCRIPTION ================= */
document.getElementById("registerForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const type = document.getElementById("typeInscription").value;
  const messageDiv = document.getElementById("registerMessage");

  if (!type) {
    messageDiv.innerHTML = '<div class="alert alert-warning">Choisissez Client ou Hôte</div>';
    return;
  }

  const data = {
    nom: document.getElementById("nom").value,
    prenom: document.getElementById("prenom").value,
    email: document.getElementById("emailInscr").value,
    telephone: document.getElementById("telephone").value,
    password: document.getElementById("passwordInscr").value
  };

  const url = type === "client"
    ? "http://localhost:3000/register/client"
    : "http://localhost:3000/register/hote";

  try {
    messageDiv.innerHTML = '<div class="alert alert-info">Inscription en cours...</div>';

    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok) {
      messageDiv.innerHTML = '<div class="alert alert-success">' + result.message + ' Vous pouvez maintenant vous connecter.</div>';
      document.getElementById("registerForm").reset();
    } else {
      messageDiv.innerHTML = '<div class="alert alert-danger">' + result.message + '</div>';
    }
  } catch (err) {
    console.error(err);
    messageDiv.innerHTML = '<div class="alert alert-danger">Erreur de connexion au serveur</div>';
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>